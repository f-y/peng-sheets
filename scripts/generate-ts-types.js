const fs = require('fs');
const path = require('path');
const { compile } = require('json-schema-to-typescript');
const { execSync } = require('child_process');

const PROJECT_ROOT = path.resolve(__dirname, '..');
const PYTHON_MODULES_DIR = path.join(PROJECT_ROOT, 'python-modules');
const SCHEMA_FILE = path.join(PROJECT_ROOT, 'schemas', 'visual-metadata.schema.json');
// Determine output path. 
// webview-ui is where we use these types.
const OUTPUT_FILE = path.join(PROJECT_ROOT, 'webview-ui', 'types', 'metadata.d.ts'); // .d.ts or .ts? .d.ts is fine.

async function main() {
    console.log('Generating JSON Schema from Python sources...');
    try {
        // Run python script via uv
        execSync('uv run scripts/generate_schema.py', {
            cwd: PYTHON_MODULES_DIR,
            stdio: 'inherit'
        });
    } catch (e) {
        console.error('Failed to generate Python schema');
        process.exit(1);
    }

    if (!fs.existsSync(SCHEMA_FILE)) {
        console.error(`Schema file not found at ${SCHEMA_FILE}`);
        process.exit(1);
    }

    console.log('Compiling Schema to TypeScript...');
    const schema = JSON.parse(fs.readFileSync(SCHEMA_FILE, 'utf-8'));

    // Compile
    try {
        const ts = await compile(schema, 'VisualMetadata', {
            bannerComment: `/* eslint-disable */
/**
 * This file was automatically generated by json-schema-to-typescript.
 * DO NOT MODIFY IT BY HAND. Instead, modify the source Python TypedDicts.
 */`,
            style: {
                singleQuote: true
            }
        });

        // Ensure directory exists
        const outDir = path.dirname(OUTPUT_FILE);
        if (!fs.existsSync(outDir)) {
            fs.mkdirSync(outDir, { recursive: true });
        }

        fs.writeFileSync(OUTPUT_FILE, ts);
        console.log(`TypeScript definitions generated at: ${OUTPUT_FILE}`);
    } catch (e) {
        console.error('Error compiling to TypeScript:', e);
        process.exit(1);
    }
}

main();
